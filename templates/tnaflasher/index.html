{% extends "base.html" %}
{% from "macros.jinja" import window_vars with context %}

{% block page %}
<div class="row q-col-gutter-md">
  <div class="col-12 q-mb-md">
    <h3 class="q-mb-none">
      <img src="/tnaflasher/static/images/tnaflasher.png" alt="TNA" style="height: 40px; vertical-align: middle;" onerror="this.style.display='none'">
      Tech Nerd Army Web Flasher
    </h3>
    <p class="text-subtitle1 text-grey">Admin Dashboard</p>
  </div>

  <!-- Stats Cards -->
  <div class="col-12 col-md-3">
    <q-card>
      <q-card-section class="text-center">
        <div class="text-h4">${ stats.total_flashes }</div>
        <div class="text-subtitle2">Total Flashes</div>
      </q-card-section>
    </q-card>
  </div>
  <div class="col-12 col-md-3">
    <q-card>
      <q-card-section class="text-center">
        <div class="text-h4">${ formatSats(stats.total_sats) }</div>
        <div class="text-subtitle2">Total SATS Earned</div>
      </q-card-section>
    </q-card>
  </div>
  <div class="col-12 col-md-3">
    <q-card>
      <q-card-section class="text-center">
        <div class="text-h4">${ stats.today_flashes }</div>
        <div class="text-subtitle2">Today's Flashes</div>
      </q-card-section>
    </q-card>
  </div>
  <div class="col-12 col-md-3">
    <q-card>
      <q-card-section class="text-center">
        <div class="text-h4">${ priceSats }</div>
        <div class="text-subtitle2">Price (SATS)</div>
      </q-card-section>
    </q-card>
  </div>

  <!-- Configuration -->
  <div class="col-12 col-md-6">
    <q-card>
      <q-card-section>
        <div class="text-h6 q-mb-md">Configuration</div>

        <div class="row q-col-gutter-md">
          <div class="col-12">
            <q-input
              v-model.number="priceSats"
              type="number"
              label="Flash Price (SATS)"
              outlined
              dense
            >
              <template v-slot:append>
                <q-btn flat dense icon="save" @click="savePrice" :loading="savingPrice">
                  <q-tooltip>Save Price</q-tooltip>
                </q-btn>
              </template>
            </q-input>
          </div>

          <div class="col-12">
            <q-select
              v-model="selectedWallet"
              :options="walletOptions"
              label="Receiving Wallet"
              outlined
              dense
              emit-value
              map-options
              @update:model-value="saveWallet"
            />
          </div>

          <div class="col-12">
            <q-input
              v-model="publicUrl"
              label="Public Flasher URL"
              outlined
              dense
              readonly
            >
              <template v-slot:append>
                <q-btn flat dense icon="content_copy" @click="copyPublicUrl">
                  <q-tooltip>Copy URL</q-tooltip>
                </q-btn>
              </template>
            </q-input>
          </div>
        </div>
      </q-card-section>
    </q-card>
  </div>

  <!-- News/Bulletins Management -->
  <div class="col-12 col-md-6">
    <q-card>
      <q-card-section>
        <div class="row items-center q-mb-md">
          <div class="text-h6">News & Updates</div>
          <q-space></q-space>
          <q-btn flat icon="refresh" @click="loadBulletins" :loading="loadingBulletins">
            <q-tooltip>Refresh</q-tooltip>
          </q-btn>
        </div>

        <!-- Add new bulletin -->
        <div class="row q-col-gutter-sm q-mb-md">
          <div class="col">
            <q-input
              v-model="newBulletinMessage"
              label="New bulletin message"
              outlined
              dense
              placeholder="Enter a news update or announcement..."
            />
          </div>
          <div class="col-auto">
            <q-btn
              color="primary"
              icon="add"
              @click="addBulletin"
              :loading="addingBulletin"
              :disable="!newBulletinMessage"
            >
              <q-tooltip>Add Bulletin</q-tooltip>
            </q-btn>
          </div>
        </div>

        <!-- Existing bulletins -->
        <q-list v-if="bulletins.length > 0" bordered separator>
          <q-item v-for="bulletin in bulletins" :key="bulletin.id">
            <q-item-section avatar>
              <q-icon :name="bulletin.active ? 'campaign' : 'visibility_off'" :color="bulletin.active ? 'orange' : 'grey'" />
            </q-item-section>
            <q-item-section>
              <q-item-label :class="{ 'text-grey': !bulletin.active }">${ bulletin.message }</q-item-label>
              <q-item-label caption>${ formatDate(bulletin.created_at) }</q-item-label>
            </q-item-section>
            <q-item-section side>
              <div class="row q-gutter-xs">
                <q-btn
                  flat
                  dense
                  :icon="bulletin.active ? 'visibility_off' : 'visibility'"
                  @click="toggleBulletin(bulletin)"
                  :color="bulletin.active ? 'warning' : 'positive'"
                >
                  <q-tooltip>${ bulletin.active ? 'Hide' : 'Show' }</q-tooltip>
                </q-btn>
                <q-btn flat dense icon="delete" color="negative" @click="deleteBulletin(bulletin)">
                  <q-tooltip>Delete</q-tooltip>
                </q-btn>
              </div>
            </q-item-section>
          </q-item>
        </q-list>
        <div v-else class="text-grey text-center q-pa-md">
          No bulletins yet. Add one above to show on the public page.
        </div>
      </q-card-section>
    </q-card>
  </div>

  <!-- Promo Codes Management -->
  <div class="col-12 col-md-6">
    <q-card>
      <q-card-section>
        <div class="row items-center q-mb-md">
          <div class="text-h6">Promo Codes</div>
          <q-space></q-space>
          <q-btn flat icon="refresh" @click="loadPromoCodes" :loading="loadingPromoCodes">
            <q-tooltip>Refresh</q-tooltip>
          </q-btn>
        </div>

        <!-- Add new promo code -->
        <div class="row q-col-gutter-sm q-mb-md items-end">
          <div class="col-12 col-sm-4">
            <q-input
              v-model="newPromoCode"
              label="Code"
              outlined
              dense
              placeholder="e.g. SUMMER2024"
              :rules="[val => !!val || 'Required']"
            />
          </div>
          <div class="col-6 col-sm-3">
            <q-input
              v-model.number="newPromoDiscount"
              type="number"
              label="Discount %"
              outlined
              dense
              min="1"
              max="100"
              :rules="[val => val >= 1 && val <= 100 || '1-100']"
            />
          </div>
          <div class="col-6 col-sm-3">
            <q-input
              v-model.number="newPromoMaxUses"
              type="number"
              label="Max Uses"
              outlined
              dense
              min="1"
              :rules="[val => val >= 1 || 'Min 1']"
            />
          </div>
          <div class="col-auto">
            <q-btn
              color="primary"
              icon="add"
              @click="addPromoCode"
              :loading="addingPromoCode"
              :disable="!newPromoCode || !newPromoDiscount || !newPromoMaxUses"
            >
              <q-tooltip>Add Promo Code</q-tooltip>
            </q-btn>
          </div>
        </div>

        <!-- Existing promo codes -->
        <q-list v-if="promoCodes.length > 0" bordered separator>
          <q-item v-for="promo in promoCodes" :key="promo.id">
            <q-item-section avatar>
              <q-icon :name="promo.active ? 'local_offer' : 'visibility_off'" :color="promo.active ? 'orange' : 'grey'" />
            </q-item-section>
            <q-item-section>
              <q-item-label :class="{ 'text-grey': !promo.active }">
                <span class="text-weight-bold">${ promo.code }</span>
                <q-badge :color="promo.discount_percent === 100 ? 'positive' : 'primary'" class="q-ml-sm">
                  ${ promo.discount_percent }% off
                </q-badge>
              </q-item-label>
              <q-item-label caption>
                Used: ${ promo.used_count } / ${ promo.max_uses }
                <span v-if="promo.used_count >= promo.max_uses" class="text-negative">(exhausted)</span>
              </q-item-label>
            </q-item-section>
            <q-item-section side>
              <div class="row q-gutter-xs">
                <q-btn
                  flat
                  dense
                  :icon="promo.active ? 'visibility_off' : 'visibility'"
                  @click="togglePromoCode(promo)"
                  :color="promo.active ? 'warning' : 'positive'"
                >
                  <q-tooltip>${ promo.active ? 'Disable' : 'Enable' }</q-tooltip>
                </q-btn>
                <q-btn flat dense icon="delete" color="negative" @click="deletePromoCode(promo)">
                  <q-tooltip>Delete</q-tooltip>
                </q-btn>
              </div>
            </q-item-section>
          </q-item>
        </q-list>
        <div v-else class="text-grey text-center q-pa-md">
          No promo codes yet. Add one above to offer discounts.
        </div>
      </q-card-section>
    </q-card>
  </div>

  <!-- Firmware Management -->
  <div class="col-12 col-md-6">
    <q-card>
      <q-card-section>
        <div class="row items-center q-mb-md">
          <div class="text-h6">Firmware Management</div>
          <q-space></q-space>
          <q-btn flat icon="refresh" @click="loadDevices" :loading="loadingDevices">
            <q-tooltip>Refresh</q-tooltip>
          </q-btn>
        </div>

        <q-list bordered separator>
          <q-expansion-item v-for="device in devices" :key="device.id" :label="device.name" header-class="text-weight-medium">
            <q-card>
              <q-card-section>
                <!-- Existing versions -->
                <div v-if="device.versions.length > 0" class="q-mb-md">
                  <div class="text-caption text-grey q-mb-sm">Installed versions:</div>
                  <q-chip
                    v-for="version in device.versions"
                    :key="version"
                    removable
                    @remove="deleteFirmware(device.id, version)"
                    color="primary"
                    text-color="white"
                    size="sm"
                  >
                    ${ version }
                  </q-chip>
                </div>
                <div v-else class="text-grey q-mb-md">No firmware uploaded</div>

                <!-- Upload new version -->
                <div class="row q-col-gutter-sm items-center">
                  <div class="col-auto">
                    <q-input
                      v-model="uploadVersion[device.id]"
                      label="Version"
                      placeholder="v3.42"
                      outlined
                      dense
                      style="width: 100px"
                    />
                  </div>
                  <div class="col">
                    <q-file
                      v-model="uploadFile[device.id]"
                      label="Select .bin file"
                      outlined
                      dense
                      accept=".bin"
                    >
                      <template v-slot:prepend>
                        <q-icon name="attach_file" />
                      </template>
                    </q-file>
                  </div>
                  <div class="col-auto">
                    <q-btn
                      color="primary"
                      icon="upload"
                      @click="uploadFirmware(device.id)"
                      :loading="uploading[device.id]"
                      :disable="!uploadVersion[device.id] || !uploadFile[device.id]"
                    >
                      <q-tooltip>Upload</q-tooltip>
                    </q-btn>
                  </div>
                </div>
              </q-card-section>
            </q-card>
          </q-expansion-item>
        </q-list>
      </q-card-section>
    </q-card>
  </div>

  <!-- Recent Flash Requests -->
  <div class="col-12">
    <q-card>
      <q-card-section>
        <div class="row items-center q-mb-md">
          <div class="text-h6">Recent Flash Requests</div>
          <q-space></q-space>
          <q-btn flat icon="refresh" @click="loadRequests" :loading="loadingRequests">
            <q-tooltip>Refresh</q-tooltip>
          </q-btn>
        </div>

        <q-table
          :rows="requests"
          :columns="requestColumns"
          row-key="id"
          :loading="loadingRequests"
          :pagination="{ rowsPerPage: 20 }"
          flat
          bordered
        >
          <template v-slot:body-cell-status="props">
            <q-td :props="props">
              <q-badge
                :color="getStatusColor(props.row.status)"
                :label="props.row.status"
              />
            </q-td>
          </template>

          <template v-slot:body-cell-created_at="props">
            <q-td :props="props">
              ${ formatDate(props.row.created_at) }
            </q-td>
          </template>

          <template v-slot:body-cell-amount_sats="props">
            <q-td :props="props">
              ${ formatSats(props.row.amount_sats) }
            </q-td>
          </template>
        </q-table>
      </q-card-section>
    </q-card>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ window_vars(user) }}
<script>
  window.app = Vue.createApp({
    el: '#vue',
    mixins: [windowMixin],
    delimiters: ['${', '}'],

    data() {
      return {
        stats: {
          total_flashes: 0,
          total_sats: 0,
          today_flashes: 0,
          pending_count: 0
        },
        priceSats: 5000,
        savingPrice: false,
        selectedWallet: null,
        walletOptions: [],
        devices: [],
        loadingDevices: false,
        requests: [],
        loadingRequests: false,
        // Firmware upload
        uploadVersion: {},
        uploadFile: {},
        uploading: {},
        // Bulletins
        bulletins: [],
        loadingBulletins: false,
        newBulletinMessage: '',
        addingBulletin: false,
        // Promo Codes
        promoCodes: [],
        loadingPromoCodes: false,
        newPromoCode: '',
        newPromoDiscount: 10,
        newPromoMaxUses: 1,
        addingPromoCode: false,
        requestColumns: [
          { name: 'created_at', label: 'Date', field: 'created_at', align: 'left', sortable: true },
          { name: 'device', label: 'Device', field: 'device', align: 'left' },
          { name: 'version', label: 'Version', field: 'version', align: 'left' },
          { name: 'amount_sats', label: 'Amount', field: 'amount_sats', align: 'right' },
          { name: 'status', label: 'Status', field: 'status', align: 'center' },
        ]
      }
    },

    computed: {
      publicUrl() {
        if (!this.selectedWallet) return 'Select a wallet first'
        return `${window.location.origin}/tnaflasher/${this.selectedWallet}`
      }
    },

    methods: {
      formatSats(sats) {
        return new Intl.NumberFormat().format(sats)
      },

      formatDate(timestamp) {
        if (!timestamp) return '-'
        return new Date(timestamp * 1000).toLocaleString()
      },

      getStatusColor(status) {
        switch (status) {
          case 'flashed': return 'positive'
          case 'paid': return 'info'
          case 'pending': return 'warning'
          case 'expired': return 'negative'
          default: return 'grey'
        }
      },

      async loadStats() {
        try {
          const response = await LNbits.api.request(
            'GET',
            '/tnaflasher/api/v1/admin/stats',
            this.g.user.wallets[0].adminkey
          )
          this.stats = response.data
        } catch (e) {
          console.error('Failed to load stats:', e)
        }
      },

      async loadPrice() {
        try {
          const response = await LNbits.api.request(
            'GET',
            '/tnaflasher/api/v1/admin/price',
            this.g.user.wallets[0].adminkey
          )
          this.priceSats = response.data.price_sats
        } catch (e) {
          console.error('Failed to load price:', e)
        }
      },

      async savePrice() {
        this.savingPrice = true
        try {
          await LNbits.api.request(
            'POST',
            `/tnaflasher/api/v1/admin/price?price_sats=${this.priceSats}`,
            this.g.user.wallets[0].adminkey
          )
          this.$q.notify({ type: 'positive', message: 'Price saved!' })
        } catch (e) {
          LNbits.utils.notifyApiError(e)
        }
        this.savingPrice = false
      },

      async loadWallet() {
        try {
          const response = await LNbits.api.request(
            'GET',
            '/tnaflasher/api/v1/admin/wallet',
            this.g.user.wallets[0].adminkey
          )
          this.selectedWallet = response.data.wallet_id || null
        } catch (e) {
          console.error('Failed to load wallet:', e)
        }
      },

      async saveWallet(walletId) {
        try {
          await LNbits.api.request(
            'POST',
            `/tnaflasher/api/v1/admin/wallet?wallet_id=${walletId}`,
            this.g.user.wallets[0].adminkey
          )
          this.$q.notify({ type: 'positive', message: 'Wallet saved!' })
        } catch (e) {
          LNbits.utils.notifyApiError(e)
        }
      },

      async loadDevices() {
        this.loadingDevices = true
        try {
          const response = await LNbits.api.request('GET', '/tnaflasher/api/v1/devices')
          this.devices = response.data.devices
        } catch (e) {
          console.error('Failed to load devices:', e)
        }
        this.loadingDevices = false
      },

      async loadRequests() {
        this.loadingRequests = true
        try {
          const response = await LNbits.api.request(
            'GET',
            '/tnaflasher/api/v1/admin/requests',
            this.g.user.wallets[0].adminkey
          )
          this.requests = response.data
        } catch (e) {
          console.error('Failed to load requests:', e)
        }
        this.loadingRequests = false
      },

      async copyPublicUrl() {
        if (!this.selectedWallet) {
          this.$q.notify({ type: 'warning', message: 'Select a wallet first' })
          return
        }
        try {
          await navigator.clipboard.writeText(this.publicUrl)
          this.$q.notify({ type: 'positive', message: 'URL copied!' })
        } catch (e) {
          // Fallback for older browsers or non-HTTPS
          const textArea = document.createElement('textarea')
          textArea.value = this.publicUrl
          textArea.style.position = 'fixed'
          textArea.style.left = '-999999px'
          document.body.appendChild(textArea)
          textArea.select()
          try {
            document.execCommand('copy')
            this.$q.notify({ type: 'positive', message: 'URL copied!' })
          } catch (err) {
            this.$q.notify({ type: 'negative', message: 'Failed to copy URL' })
          }
          document.body.removeChild(textArea)
        }
      },

      async uploadFirmware(deviceId) {
        const version = this.uploadVersion[deviceId]
        const file = this.uploadFile[deviceId]

        if (!version || !file) {
          this.$q.notify({ type: 'warning', message: 'Please enter version and select a file' })
          return
        }

        this.uploading[deviceId] = true
        try {
          const formData = new FormData()
          formData.append('file', file)

          await fetch(
            `/tnaflasher/api/v1/admin/firmware/upload?device=${deviceId}&version=${version}`,
            {
              method: 'POST',
              headers: {
                'X-Api-Key': this.g.user.wallets[0].adminkey
              },
              body: formData
            }
          )

          this.$q.notify({ type: 'positive', message: `Firmware ${version} uploaded for ${deviceId}` })
          this.uploadVersion[deviceId] = ''
          this.uploadFile[deviceId] = null
          await this.loadDevices()
        } catch (e) {
          console.error('Upload failed:', e)
          this.$q.notify({ type: 'negative', message: 'Upload failed' })
        }
        this.uploading[deviceId] = false
      },

      async deleteFirmware(deviceId, version) {
        this.$q.dialog({
          title: 'Delete Firmware',
          message: `Are you sure you want to delete ${deviceId} ${version}?`,
          cancel: true,
          persistent: true
        }).onOk(async () => {
          try {
            await fetch(
              `/tnaflasher/api/v1/admin/firmware/${deviceId}/${version}`,
              {
                method: 'DELETE',
                headers: {
                  'X-Api-Key': this.g.user.wallets[0].adminkey
                }
              }
            )
            this.$q.notify({ type: 'positive', message: `Firmware ${version} deleted` })
            await this.loadDevices()
          } catch (e) {
            console.error('Delete failed:', e)
            this.$q.notify({ type: 'negative', message: 'Delete failed' })
          }
        })
      },

      // Bulletin methods
      async loadBulletins() {
        this.loadingBulletins = true
        try {
          const response = await LNbits.api.request(
            'GET',
            '/tnaflasher/api/v1/admin/bulletins',
            this.g.user.wallets[0].adminkey
          )
          this.bulletins = response.data.bulletins || []
        } catch (e) {
          console.error('Failed to load bulletins:', e)
        }
        this.loadingBulletins = false
      },

      async addBulletin() {
        if (!this.newBulletinMessage) return
        this.addingBulletin = true
        try {
          await LNbits.api.request(
            'POST',
            '/tnaflasher/api/v1/admin/bulletins',
            this.g.user.wallets[0].adminkey,
            { message: this.newBulletinMessage }
          )
          this.$q.notify({ type: 'positive', message: 'Bulletin added!' })
          this.newBulletinMessage = ''
          await this.loadBulletins()
        } catch (e) {
          LNbits.utils.notifyApiError(e)
        }
        this.addingBulletin = false
      },

      async toggleBulletin(bulletin) {
        try {
          await LNbits.api.request(
            'PUT',
            `/tnaflasher/api/v1/admin/bulletins/${bulletin.id}?active=${!bulletin.active}`,
            this.g.user.wallets[0].adminkey
          )
          this.$q.notify({ type: 'positive', message: bulletin.active ? 'Bulletin hidden' : 'Bulletin visible' })
          await this.loadBulletins()
        } catch (e) {
          LNbits.utils.notifyApiError(e)
        }
      },

      async deleteBulletin(bulletin) {
        this.$q.dialog({
          title: 'Delete Bulletin',
          message: 'Are you sure you want to delete this bulletin?',
          cancel: true,
          persistent: true
        }).onOk(async () => {
          try {
            await LNbits.api.request(
              'DELETE',
              `/tnaflasher/api/v1/admin/bulletins/${bulletin.id}`,
              this.g.user.wallets[0].adminkey
            )
            this.$q.notify({ type: 'positive', message: 'Bulletin deleted' })
            await this.loadBulletins()
          } catch (e) {
            LNbits.utils.notifyApiError(e)
          }
        })
      },

      // Promo Code methods
      async loadPromoCodes() {
        this.loadingPromoCodes = true
        try {
          const response = await LNbits.api.request(
            'GET',
            '/tnaflasher/api/v1/admin/promo-codes',
            this.g.user.wallets[0].adminkey
          )
          this.promoCodes = response.data.promo_codes || []
        } catch (e) {
          console.error('Failed to load promo codes:', e)
        }
        this.loadingPromoCodes = false
      },

      async addPromoCode() {
        if (!this.newPromoCode || !this.newPromoDiscount || !this.newPromoMaxUses) return
        this.addingPromoCode = true
        try {
          await LNbits.api.request(
            'POST',
            '/tnaflasher/api/v1/admin/promo-codes',
            this.g.user.wallets[0].adminkey,
            {
              code: this.newPromoCode,
              discount_percent: this.newPromoDiscount,
              max_uses: this.newPromoMaxUses
            }
          )
          this.$q.notify({ type: 'positive', message: 'Promo code created!' })
          this.newPromoCode = ''
          this.newPromoDiscount = 10
          this.newPromoMaxUses = 1
          await this.loadPromoCodes()
        } catch (e) {
          LNbits.utils.notifyApiError(e)
        }
        this.addingPromoCode = false
      },

      async togglePromoCode(promo) {
        try {
          await LNbits.api.request(
            'PUT',
            `/tnaflasher/api/v1/admin/promo-codes/${promo.id}?active=${!promo.active}`,
            this.g.user.wallets[0].adminkey
          )
          this.$q.notify({ type: 'positive', message: promo.active ? 'Promo code disabled' : 'Promo code enabled' })
          await this.loadPromoCodes()
        } catch (e) {
          LNbits.utils.notifyApiError(e)
        }
      },

      async deletePromoCode(promo) {
        this.$q.dialog({
          title: 'Delete Promo Code',
          message: `Are you sure you want to delete promo code "${promo.code}"?`,
          cancel: true,
          persistent: true
        }).onOk(async () => {
          try {
            await LNbits.api.request(
              'DELETE',
              `/tnaflasher/api/v1/admin/promo-codes/${promo.id}`,
              this.g.user.wallets[0].adminkey
            )
            this.$q.notify({ type: 'positive', message: 'Promo code deleted' })
            await this.loadPromoCodes()
          } catch (e) {
            LNbits.utils.notifyApiError(e)
          }
        })
      }
    },

    async created() {
      // Build wallet options from user's wallets
      this.walletOptions = this.g.user.wallets.map(w => ({
        label: w.name,
        value: w.id
      }))

      // Load all data
      await this.loadStats()
      await this.loadPrice()
      await this.loadWallet()
      await this.loadDevices()
      await this.loadRequests()
      await this.loadBulletins()
      await this.loadPromoCodes()
    }
  })

  window.app.mount('#vue')
</script>
{% endblock %}
