{% extends "base.html" %}
{% from "macros.jinja" import window_vars with context %}

{% block page %}
<div class="row q-col-gutter-md">
  <div class="col-12 q-mb-md">
    <h3 class="q-mb-none">
      <img src="/tnaflasher/static/images/tnaflasher.png" alt="TNA" style="height: 40px; vertical-align: middle;" onerror="this.style.display='none'">
      Tech Nerd Army Web Flasher
    </h3>
    <p class="text-subtitle1 text-grey">Admin Dashboard</p>
  </div>

  <!-- Stats Cards -->
  <div class="col-12 col-md-3">
    <q-card>
      <q-card-section class="text-center">
        <div class="text-h4">${ stats.total_flashes }</div>
        <div class="text-subtitle2">Total Flashes</div>
      </q-card-section>
    </q-card>
  </div>
  <div class="col-12 col-md-3">
    <q-card>
      <q-card-section class="text-center">
        <div class="text-h4">${ formatSats(stats.total_sats) }</div>
        <div class="text-subtitle2">Total SATS Earned</div>
      </q-card-section>
    </q-card>
  </div>
  <div class="col-12 col-md-3">
    <q-card>
      <q-card-section class="text-center">
        <div class="text-h4">${ stats.today_flashes }</div>
        <div class="text-subtitle2">Today's Flashes</div>
      </q-card-section>
    </q-card>
  </div>
  <div class="col-12 col-md-3">
    <q-card>
      <q-card-section class="text-center">
        <div class="text-h4">${ miners.length }</div>
        <div class="text-subtitle2">Miners</div>
      </q-card-section>
    </q-card>
  </div>

  <!-- Configuration -->
  <div class="col-12 col-md-6">
    <q-card>
      <q-card-section>
        <div class="text-h6 q-mb-md">Configuration</div>

        <div class="row q-col-gutter-md">
          <div class="col-12">
            <q-select
              v-model="selectedWallet"
              :options="walletOptions"
              label="Receiving Wallet"
              outlined
              dense
              emit-value
              map-options
              @update:model-value="saveWallet"
            />
          </div>

          <div class="col-12">
            <q-input
              v-model="publicUrl"
              label="Public Flasher URL"
              outlined
              dense
              readonly
            >
              <template v-slot:append>
                <q-btn flat dense icon="content_copy" @click="copyPublicUrl">
                  <q-tooltip>Copy URL</q-tooltip>
                </q-btn>
              </template>
            </q-input>
          </div>
        </div>
      </q-card-section>
    </q-card>
  </div>

  <!-- News/Bulletins Management -->
  <div class="col-12 col-md-6">
    <q-card>
      <q-card-section>
        <div class="row items-center q-mb-md">
          <div class="text-h6">News & Updates</div>
          <q-space></q-space>
          <q-btn flat icon="refresh" @click="loadBulletins" :loading="loadingBulletins">
            <q-tooltip>Refresh</q-tooltip>
          </q-btn>
        </div>

        <!-- Add new bulletin -->
        <div class="row q-col-gutter-sm q-mb-md">
          <div class="col">
            <q-input
              v-model="newBulletinMessage"
              label="New bulletin message"
              outlined
              dense
              placeholder="Enter a news update or announcement..."
            />
          </div>
          <div class="col-auto">
            <q-btn
              color="primary"
              icon="add"
              @click="addBulletin"
              :loading="addingBulletin"
              :disable="!newBulletinMessage"
            >
              <q-tooltip>Add Bulletin</q-tooltip>
            </q-btn>
          </div>
        </div>

        <!-- Existing bulletins -->
        <q-list v-if="bulletins.length > 0" bordered separator>
          <q-item v-for="bulletin in bulletins" :key="bulletin.id">
            <q-item-section avatar>
              <q-icon :name="bulletin.active ? 'campaign' : 'visibility_off'" :color="bulletin.active ? 'orange' : 'grey'" />
            </q-item-section>
            <q-item-section>
              <q-item-label :class="{ 'text-grey': !bulletin.active }">${ bulletin.message }</q-item-label>
              <q-item-label caption>${ formatDate(bulletin.created_at) }</q-item-label>
            </q-item-section>
            <q-item-section side>
              <div class="row q-gutter-xs">
                <q-btn
                  flat
                  dense
                  :icon="bulletin.active ? 'visibility_off' : 'visibility'"
                  @click="toggleBulletin(bulletin)"
                  :color="bulletin.active ? 'warning' : 'positive'"
                >
                  <q-tooltip>${ bulletin.active ? 'Hide' : 'Show' }</q-tooltip>
                </q-btn>
                <q-btn flat dense icon="delete" color="negative" @click="deleteBulletin(bulletin)">
                  <q-tooltip>Delete</q-tooltip>
                </q-btn>
              </div>
            </q-item-section>
          </q-item>
        </q-list>
        <div v-else class="text-grey text-center q-pa-md">
          No bulletins yet. Add one above to show on the public page.
        </div>
      </q-card-section>
    </q-card>
  </div>

  <!-- Promo Codes Management -->
  <div class="col-12 col-md-6">
    <q-card>
      <q-card-section>
        <div class="row items-center q-mb-md">
          <div class="text-h6">Promo Codes</div>
          <q-space></q-space>
          <q-btn flat icon="refresh" @click="loadPromoCodes" :loading="loadingPromoCodes">
            <q-tooltip>Refresh</q-tooltip>
          </q-btn>
        </div>

        <!-- Add new promo code -->
        <div class="row q-col-gutter-sm q-mb-md items-end">
          <div class="col-12 col-sm-4">
            <q-input
              v-model="newPromoCode"
              label="Code"
              outlined
              dense
              placeholder="e.g. SUMMER2024"
              :rules="[val => !!val || 'Required']"
            />
          </div>
          <div class="col-6 col-sm-3">
            <q-input
              v-model.number="newPromoDiscount"
              type="number"
              label="Discount %"
              outlined
              dense
              min="1"
              max="100"
              :rules="[val => val >= 1 && val <= 100 || '1-100']"
            />
          </div>
          <div class="col-6 col-sm-3">
            <q-input
              v-model.number="newPromoMaxUses"
              type="number"
              label="Max Uses"
              outlined
              dense
              min="1"
              :rules="[val => val >= 1 || 'Min 1']"
            />
          </div>
          <div class="col-auto">
            <q-btn
              color="primary"
              icon="add"
              @click="addPromoCode"
              :loading="addingPromoCode"
              :disable="!newPromoCode || !newPromoDiscount || !newPromoMaxUses"
            >
              <q-tooltip>Add Promo Code</q-tooltip>
            </q-btn>
          </div>
        </div>

        <!-- Existing promo codes -->
        <q-list v-if="promoCodes.length > 0" bordered separator>
          <q-item v-for="promo in promoCodes" :key="promo.id">
            <q-item-section avatar>
              <q-icon :name="promo.active ? 'local_offer' : 'visibility_off'" :color="promo.active ? 'orange' : 'grey'" />
            </q-item-section>
            <q-item-section>
              <q-item-label :class="{ 'text-grey': !promo.active }">
                <span class="text-weight-bold">${ promo.code }</span>
                <q-badge :color="promo.discount_percent === 100 ? 'positive' : 'primary'" class="q-ml-sm">
                  ${ promo.discount_percent }% off
                </q-badge>
              </q-item-label>
              <q-item-label caption>
                Used: ${ promo.used_count } / ${ promo.max_uses }
                <span v-if="promo.used_count >= promo.max_uses" class="text-negative">(exhausted)</span>
              </q-item-label>
            </q-item-section>
            <q-item-section side>
              <div class="row q-gutter-xs">
                <q-btn
                  flat
                  dense
                  :icon="promo.active ? 'visibility_off' : 'visibility'"
                  @click="togglePromoCode(promo)"
                  :color="promo.active ? 'warning' : 'positive'"
                >
                  <q-tooltip>${ promo.active ? 'Disable' : 'Enable' }</q-tooltip>
                </q-btn>
                <q-btn flat dense icon="delete" color="negative" @click="deletePromoCode(promo)">
                  <q-tooltip>Delete</q-tooltip>
                </q-btn>
              </div>
            </q-item-section>
          </q-item>
        </q-list>
        <div v-else class="text-grey text-center q-pa-md">
          No promo codes yet. Add one above to offer discounts.
        </div>
      </q-card-section>
    </q-card>
  </div>

  <!-- Miner Management -->
  <div class="col-12 col-md-6">
    <q-card>
      <q-card-section>
        <div class="row items-center q-mb-md">
          <div class="text-h6">Miner Types</div>
          <q-space></q-space>
          <q-btn flat icon="refresh" @click="loadMiners" :loading="loadingMiners">
            <q-tooltip>Refresh</q-tooltip>
          </q-btn>
        </div>

        <!-- Add new miner -->
        <div class="row q-col-gutter-sm q-mb-md">
          <div class="col">
            <q-input
              v-model="newMinerName"
              label="Miner Name"
              outlined
              dense
              placeholder="e.g. Bitaxe, NerdQAxe++"
            />
          </div>
          <div class="col-auto">
            <q-btn
              color="primary"
              icon="add"
              @click="addMiner"
              :loading="addingMiner"
              :disable="!newMinerName"
            >
              <q-tooltip>Add Miner</q-tooltip>
            </q-btn>
          </div>
        </div>

        <!-- Existing miners -->
        <q-list v-if="miners.length > 0" bordered separator>
          <q-item v-for="miner in miners" :key="miner.id">
            <q-item-section avatar>
              <q-icon name="memory" color="orange" />
            </q-item-section>
            <q-item-section>
              <q-item-label class="text-weight-bold">${ miner.name }</q-item-label>
              <q-item-label caption>ID: ${ miner.id.substring(0, 8) }...</q-item-label>
            </q-item-section>
            <q-item-section side>
              <q-btn flat dense icon="delete" color="negative" @click="deleteMiner(miner)">
                <q-tooltip>Delete Miner</q-tooltip>
              </q-btn>
            </q-item-section>
          </q-item>
        </q-list>
        <div v-else class="text-grey text-center q-pa-md">
          No miners yet. Add one above to start uploading firmware.
        </div>
      </q-card-section>
    </q-card>
  </div>

  <!-- Firmware Management -->
  <div class="col-12">
    <q-card>
      <q-card-section>
        <div class="row items-center q-mb-md">
          <div class="text-h6">Firmware Management</div>
          <q-space></q-space>
          <q-btn flat icon="refresh" @click="loadMiners" :loading="loadingMiners">
            <q-tooltip>Refresh</q-tooltip>
          </q-btn>
        </div>

        <div v-if="miners.length === 0" class="text-grey text-center q-pa-md">
          Add a miner first to upload firmware.
        </div>

        <q-list v-else bordered separator>
          <q-expansion-item
            v-for="miner in miners"
            :key="miner.id"
            :label="miner.name"
            header-class="text-weight-medium"
            expand-icon-class="text-orange"
          >
            <q-card>
              <q-card-section>
                <!-- Existing firmware -->
                <div v-if="minerFirmware[miner.id] && minerFirmware[miner.id].length > 0" class="q-mb-md">
                  <div class="text-caption text-grey q-mb-sm">Uploaded firmware:</div>
                  <q-list bordered separator>
                    <q-item v-for="fw in minerFirmware[miner.id]" :key="fw.id">
                      <q-item-section avatar>
                        <q-icon name="description" color="primary" />
                      </q-item-section>
                      <q-item-section>
                        <q-item-label>
                          <span class="text-weight-bold">${ fw.version }</span>
                          <q-badge color="orange" class="q-ml-sm">${ formatSats(fw.price_sats) } sats</q-badge>
                          <q-badge v-if="fw.discount_enabled" color="positive" class="q-ml-xs">Discount OK</q-badge>
                          <q-badge v-else color="grey" class="q-ml-xs">No Discount</q-badge>
                        </q-item-label>
                        <q-item-label caption v-if="fw.notes">${ fw.notes }</q-item-label>
                      </q-item-section>
                      <q-item-section side>
                        <div class="row q-gutter-xs">
                          <q-btn flat dense icon="edit" color="primary" @click="editFirmware(fw)">
                            <q-tooltip>Edit</q-tooltip>
                          </q-btn>
                          <q-btn flat dense icon="delete" color="negative" @click="deleteFirmwareItem(fw)">
                            <q-tooltip>Delete</q-tooltip>
                          </q-btn>
                        </div>
                      </q-item-section>
                    </q-item>
                  </q-list>
                </div>
                <div v-else class="text-grey q-mb-md">No firmware uploaded for this miner</div>

                <!-- Upload new firmware -->
                <div class="text-caption text-grey q-mb-sm">Upload new firmware:</div>
                <div class="row q-col-gutter-sm items-end">
                  <div class="col-12 col-sm-2">
                    <q-input
                      v-model="uploadData[miner.id].version"
                      label="Version"
                      placeholder="v3.42"
                      outlined
                      dense
                    />
                  </div>
                  <div class="col-12 col-sm-2">
                    <q-input
                      v-model.number="uploadData[miner.id].price_sats"
                      type="number"
                      label="Price (sats)"
                      outlined
                      dense
                      min="0"
                    />
                  </div>
                  <div class="col-12 col-sm-3">
                    <q-input
                      v-model="uploadData[miner.id].notes"
                      label="Notes (optional)"
                      placeholder="e.g. Stable release"
                      outlined
                      dense
                    />
                  </div>
                  <div class="col-auto">
                    <q-checkbox
                      v-model="uploadData[miner.id].discount_enabled"
                      label="Allow Discount"
                      dense
                    />
                  </div>
                  <div class="col-12 col-sm-3">
                    <q-file
                      v-model="uploadData[miner.id].file"
                      label="Select .bin file"
                      outlined
                      dense
                      accept=".bin"
                    >
                      <template v-slot:prepend>
                        <q-icon name="attach_file" />
                      </template>
                    </q-file>
                  </div>
                  <div class="col-auto">
                    <q-btn
                      color="primary"
                      icon="upload"
                      @click="uploadFirmware(miner.id)"
                      :loading="uploading[miner.id]"
                      :disable="!uploadData[miner.id].version || !uploadData[miner.id].file || uploadData[miner.id].price_sats === null"
                    >
                      <q-tooltip>Upload</q-tooltip>
                    </q-btn>
                  </div>
                </div>
              </q-card-section>
            </q-card>
          </q-expansion-item>
        </q-list>
      </q-card-section>
    </q-card>
  </div>

  <!-- Recent Flash Requests -->
  <div class="col-12">
    <q-card>
      <q-card-section>
        <div class="row items-center q-mb-md">
          <div class="text-h6">Recent Flash Requests</div>
          <q-space></q-space>
          <q-btn flat icon="refresh" @click="loadRequests" :loading="loadingRequests">
            <q-tooltip>Refresh</q-tooltip>
          </q-btn>
        </div>

        <q-table
          :rows="requests"
          :columns="requestColumns"
          row-key="id"
          :loading="loadingRequests"
          :pagination="{ rowsPerPage: 20 }"
          flat
          bordered
        >
          <template v-slot:body-cell-status="props">
            <q-td :props="props">
              <q-badge
                :color="getStatusColor(props.row.status)"
                :label="props.row.status"
              />
            </q-td>
          </template>

          <template v-slot:body-cell-created_at="props">
            <q-td :props="props">
              ${ formatDate(props.row.created_at) }
            </q-td>
          </template>

          <template v-slot:body-cell-amount_sats="props">
            <q-td :props="props">
              ${ formatSats(props.row.amount_sats) }
            </q-td>
          </template>
        </q-table>
      </q-card-section>
    </q-card>
  </div>
</div>

<!-- Edit Firmware Dialog -->
<q-dialog v-model="editFirmwareDialog" persistent>
  <q-card style="min-width: 400px">
    <q-card-section>
      <div class="text-h6">Edit Firmware</div>
    </q-card-section>

    <q-card-section class="q-pt-none">
      <q-input
        v-model.number="editFirmwareData.price_sats"
        type="number"
        label="Price (sats)"
        outlined
        dense
        min="0"
        class="q-mb-md"
      />
      <q-input
        v-model="editFirmwareData.notes"
        label="Notes"
        outlined
        dense
        class="q-mb-md"
      />
      <q-checkbox
        v-model="editFirmwareData.discount_enabled"
        label="Allow Discount Codes"
      />
    </q-card-section>

    <q-card-actions align="right">
      <q-btn flat label="Cancel" color="grey" v-close-popup />
      <q-btn flat label="Save" color="primary" @click="saveFirmwareEdit" :loading="savingFirmware" />
    </q-card-actions>
  </q-card>
</q-dialog>
{% endblock %}

{% block scripts %}
{{ window_vars(user) }}
<script>
  window.app = Vue.createApp({
    el: '#vue',
    mixins: [windowMixin],
    delimiters: ['${', '}'],

    data() {
      return {
        stats: {
          total_flashes: 0,
          total_sats: 0,
          today_flashes: 0,
          pending_count: 0
        },
        selectedWallet: null,
        walletOptions: [],
        requests: [],
        loadingRequests: false,
        // Miners
        miners: [],
        loadingMiners: false,
        newMinerName: '',
        addingMiner: false,
        // Firmware per miner
        minerFirmware: {},
        uploadData: {},
        uploading: {},
        // Edit firmware dialog
        editFirmwareDialog: false,
        editFirmwareData: {
          id: null,
          price_sats: 0,
          notes: '',
          discount_enabled: true
        },
        savingFirmware: false,
        // Bulletins
        bulletins: [],
        loadingBulletins: false,
        newBulletinMessage: '',
        addingBulletin: false,
        // Promo Codes
        promoCodes: [],
        loadingPromoCodes: false,
        newPromoCode: '',
        newPromoDiscount: 10,
        newPromoMaxUses: 1,
        addingPromoCode: false,
        requestColumns: [
          { name: 'created_at', label: 'Date', field: 'created_at', align: 'left', sortable: true },
          { name: 'device', label: 'Device', field: 'device', align: 'left' },
          { name: 'version', label: 'Version', field: 'version', align: 'left' },
          { name: 'amount_sats', label: 'Amount', field: 'amount_sats', align: 'right' },
          { name: 'status', label: 'Status', field: 'status', align: 'center' },
        ]
      }
    },

    computed: {
      publicUrl() {
        if (!this.selectedWallet) return 'Select a wallet first'
        return `${window.location.origin}/tnaflasher/${this.selectedWallet}`
      }
    },

    methods: {
      formatSats(sats) {
        return new Intl.NumberFormat().format(sats)
      },

      formatDate(timestamp) {
        if (!timestamp) return '-'
        return new Date(timestamp * 1000).toLocaleString()
      },

      getStatusColor(status) {
        switch (status) {
          case 'flashed': return 'positive'
          case 'paid': return 'info'
          case 'pending': return 'warning'
          case 'expired': return 'negative'
          default: return 'grey'
        }
      },

      initUploadData(minerId) {
        if (!this.uploadData[minerId]) {
          this.uploadData[minerId] = {
            version: '',
            price_sats: 5000,
            notes: '',
            discount_enabled: true,
            file: null
          }
        }
      },

      async loadStats() {
        try {
          const response = await LNbits.api.request(
            'GET',
            '/tnaflasher/api/v1/admin/stats',
            this.g.user.wallets[0].adminkey
          )
          this.stats = response.data
        } catch (e) {
          console.error('Failed to load stats:', e)
        }
      },

      async loadWallet() {
        try {
          const response = await LNbits.api.request(
            'GET',
            '/tnaflasher/api/v1/admin/wallet',
            this.g.user.wallets[0].adminkey
          )
          this.selectedWallet = response.data.wallet_id || null
        } catch (e) {
          console.error('Failed to load wallet:', e)
        }
      },

      async saveWallet(walletId) {
        try {
          await LNbits.api.request(
            'POST',
            `/tnaflasher/api/v1/admin/wallet?wallet_id=${walletId}`,
            this.g.user.wallets[0].adminkey
          )
          this.$q.notify({ type: 'positive', message: 'Wallet saved!' })
        } catch (e) {
          LNbits.utils.notifyApiError(e)
        }
      },

      async loadMiners() {
        this.loadingMiners = true
        try {
          const response = await LNbits.api.request(
            'GET',
            '/tnaflasher/api/v1/admin/miners',
            this.g.user.wallets[0].adminkey
          )
          this.miners = response.data.miners || []

          // Initialize upload data and load firmware for each miner
          for (const miner of this.miners) {
            this.initUploadData(miner.id)
            await this.loadMinerFirmware(miner.id)
          }
        } catch (e) {
          console.error('Failed to load miners:', e)
        }
        this.loadingMiners = false
      },

      async loadMinerFirmware(minerId) {
        try {
          const response = await LNbits.api.request(
            'GET',
            `/tnaflasher/api/v1/admin/firmware/${minerId}`,
            this.g.user.wallets[0].adminkey
          )
          this.minerFirmware[minerId] = response.data.firmware || []
        } catch (e) {
          console.error('Failed to load firmware:', e)
          this.minerFirmware[minerId] = []
        }
      },

      async addMiner() {
        if (!this.newMinerName) return
        this.addingMiner = true
        try {
          await LNbits.api.request(
            'POST',
            '/tnaflasher/api/v1/admin/miners',
            this.g.user.wallets[0].adminkey,
            { name: this.newMinerName }
          )
          this.$q.notify({ type: 'positive', message: 'Miner added!' })
          this.newMinerName = ''
          await this.loadMiners()
        } catch (e) {
          LNbits.utils.notifyApiError(e)
        }
        this.addingMiner = false
      },

      async deleteMiner(miner) {
        this.$q.dialog({
          title: 'Delete Miner',
          message: `Are you sure you want to delete "${miner.name}" and ALL its firmware?`,
          cancel: true,
          persistent: true
        }).onOk(async () => {
          try {
            await LNbits.api.request(
              'DELETE',
              `/tnaflasher/api/v1/admin/miners/${miner.id}`,
              this.g.user.wallets[0].adminkey
            )
            this.$q.notify({ type: 'positive', message: 'Miner deleted!' })
            await this.loadMiners()
          } catch (e) {
            LNbits.utils.notifyApiError(e)
          }
        })
      },

      async uploadFirmware(minerId) {
        const data = this.uploadData[minerId]

        if (!data.version || !data.file || data.price_sats === null) {
          this.$q.notify({ type: 'warning', message: 'Please fill in version, price, and select a file' })
          return
        }

        this.uploading[minerId] = true
        try {
          const formData = new FormData()
          formData.append('file', data.file)

          const params = new URLSearchParams({
            miner_id: minerId,
            version: data.version,
            price_sats: data.price_sats,
            discount_enabled: data.discount_enabled
          })
          if (data.notes) {
            params.append('notes', data.notes)
          }

          await fetch(
            `/tnaflasher/api/v1/admin/firmware/upload?${params.toString()}`,
            {
              method: 'POST',
              headers: {
                'X-Api-Key': this.g.user.wallets[0].adminkey
              },
              body: formData
            }
          )

          this.$q.notify({ type: 'positive', message: `Firmware ${data.version} uploaded!` })

          // Reset form
          this.uploadData[minerId] = {
            version: '',
            price_sats: 5000,
            notes: '',
            discount_enabled: true,
            file: null
          }

          await this.loadMinerFirmware(minerId)
        } catch (e) {
          console.error('Upload failed:', e)
          this.$q.notify({ type: 'negative', message: 'Upload failed' })
        }
        this.uploading[minerId] = false
      },

      editFirmware(fw) {
        this.editFirmwareData = {
          id: fw.id,
          price_sats: fw.price_sats,
          notes: fw.notes || '',
          discount_enabled: fw.discount_enabled
        }
        this.editFirmwareDialog = true
      },

      async saveFirmwareEdit() {
        this.savingFirmware = true
        try {
          const params = new URLSearchParams({
            price_sats: this.editFirmwareData.price_sats,
            discount_enabled: this.editFirmwareData.discount_enabled
          })
          if (this.editFirmwareData.notes !== null) {
            params.append('notes', this.editFirmwareData.notes)
          }

          await LNbits.api.request(
            'PUT',
            `/tnaflasher/api/v1/admin/firmware/${this.editFirmwareData.id}?${params.toString()}`,
            this.g.user.wallets[0].adminkey
          )
          this.$q.notify({ type: 'positive', message: 'Firmware updated!' })
          this.editFirmwareDialog = false
          await this.loadMiners()
        } catch (e) {
          LNbits.utils.notifyApiError(e)
        }
        this.savingFirmware = false
      },

      async deleteFirmwareItem(fw) {
        this.$q.dialog({
          title: 'Delete Firmware',
          message: `Are you sure you want to delete firmware ${fw.version}?`,
          cancel: true,
          persistent: true
        }).onOk(async () => {
          try {
            await LNbits.api.request(
              'DELETE',
              `/tnaflasher/api/v1/admin/firmware/${fw.id}`,
              this.g.user.wallets[0].adminkey
            )
            this.$q.notify({ type: 'positive', message: 'Firmware deleted!' })
            await this.loadMiners()
          } catch (e) {
            LNbits.utils.notifyApiError(e)
          }
        })
      },

      async loadRequests() {
        this.loadingRequests = true
        try {
          const response = await LNbits.api.request(
            'GET',
            '/tnaflasher/api/v1/admin/requests',
            this.g.user.wallets[0].adminkey
          )
          this.requests = response.data
        } catch (e) {
          console.error('Failed to load requests:', e)
        }
        this.loadingRequests = false
      },

      async copyPublicUrl() {
        if (!this.selectedWallet) {
          this.$q.notify({ type: 'warning', message: 'Select a wallet first' })
          return
        }
        try {
          await navigator.clipboard.writeText(this.publicUrl)
          this.$q.notify({ type: 'positive', message: 'URL copied!' })
        } catch (e) {
          // Fallback for older browsers or non-HTTPS
          const textArea = document.createElement('textarea')
          textArea.value = this.publicUrl
          textArea.style.position = 'fixed'
          textArea.style.left = '-999999px'
          document.body.appendChild(textArea)
          textArea.select()
          try {
            document.execCommand('copy')
            this.$q.notify({ type: 'positive', message: 'URL copied!' })
          } catch (err) {
            this.$q.notify({ type: 'negative', message: 'Failed to copy URL' })
          }
          document.body.removeChild(textArea)
        }
      },

      // Bulletin methods
      async loadBulletins() {
        this.loadingBulletins = true
        try {
          const response = await LNbits.api.request(
            'GET',
            '/tnaflasher/api/v1/admin/bulletins',
            this.g.user.wallets[0].adminkey
          )
          this.bulletins = response.data.bulletins || []
        } catch (e) {
          console.error('Failed to load bulletins:', e)
        }
        this.loadingBulletins = false
      },

      async addBulletin() {
        if (!this.newBulletinMessage) return
        this.addingBulletin = true
        try {
          await LNbits.api.request(
            'POST',
            '/tnaflasher/api/v1/admin/bulletins',
            this.g.user.wallets[0].adminkey,
            { message: this.newBulletinMessage }
          )
          this.$q.notify({ type: 'positive', message: 'Bulletin added!' })
          this.newBulletinMessage = ''
          await this.loadBulletins()
        } catch (e) {
          LNbits.utils.notifyApiError(e)
        }
        this.addingBulletin = false
      },

      async toggleBulletin(bulletin) {
        try {
          await LNbits.api.request(
            'PUT',
            `/tnaflasher/api/v1/admin/bulletins/${bulletin.id}?active=${!bulletin.active}`,
            this.g.user.wallets[0].adminkey
          )
          this.$q.notify({ type: 'positive', message: bulletin.active ? 'Bulletin hidden' : 'Bulletin visible' })
          await this.loadBulletins()
        } catch (e) {
          LNbits.utils.notifyApiError(e)
        }
      },

      async deleteBulletin(bulletin) {
        this.$q.dialog({
          title: 'Delete Bulletin',
          message: 'Are you sure you want to delete this bulletin?',
          cancel: true,
          persistent: true
        }).onOk(async () => {
          try {
            await LNbits.api.request(
              'DELETE',
              `/tnaflasher/api/v1/admin/bulletins/${bulletin.id}`,
              this.g.user.wallets[0].adminkey
            )
            this.$q.notify({ type: 'positive', message: 'Bulletin deleted' })
            await this.loadBulletins()
          } catch (e) {
            LNbits.utils.notifyApiError(e)
          }
        })
      },

      // Promo Code methods
      async loadPromoCodes() {
        this.loadingPromoCodes = true
        try {
          const response = await LNbits.api.request(
            'GET',
            '/tnaflasher/api/v1/admin/promo-codes',
            this.g.user.wallets[0].adminkey
          )
          this.promoCodes = response.data.promo_codes || []
        } catch (e) {
          console.error('Failed to load promo codes:', e)
        }
        this.loadingPromoCodes = false
      },

      async addPromoCode() {
        if (!this.newPromoCode || !this.newPromoDiscount || !this.newPromoMaxUses) return
        this.addingPromoCode = true
        try {
          await LNbits.api.request(
            'POST',
            '/tnaflasher/api/v1/admin/promo-codes',
            this.g.user.wallets[0].adminkey,
            {
              code: this.newPromoCode,
              discount_percent: this.newPromoDiscount,
              max_uses: this.newPromoMaxUses
            }
          )
          this.$q.notify({ type: 'positive', message: 'Promo code created!' })
          this.newPromoCode = ''
          this.newPromoDiscount = 10
          this.newPromoMaxUses = 1
          await this.loadPromoCodes()
        } catch (e) {
          LNbits.utils.notifyApiError(e)
        }
        this.addingPromoCode = false
      },

      async togglePromoCode(promo) {
        try {
          await LNbits.api.request(
            'PUT',
            `/tnaflasher/api/v1/admin/promo-codes/${promo.id}?active=${!promo.active}`,
            this.g.user.wallets[0].adminkey
          )
          this.$q.notify({ type: 'positive', message: promo.active ? 'Promo code disabled' : 'Promo code enabled' })
          await this.loadPromoCodes()
        } catch (e) {
          LNbits.utils.notifyApiError(e)
        }
      },

      async deletePromoCode(promo) {
        this.$q.dialog({
          title: 'Delete Promo Code',
          message: `Are you sure you want to delete promo code "${promo.code}"?`,
          cancel: true,
          persistent: true
        }).onOk(async () => {
          try {
            await LNbits.api.request(
              'DELETE',
              `/tnaflasher/api/v1/admin/promo-codes/${promo.id}`,
              this.g.user.wallets[0].adminkey
            )
            this.$q.notify({ type: 'positive', message: 'Promo code deleted' })
            await this.loadPromoCodes()
          } catch (e) {
            LNbits.utils.notifyApiError(e)
          }
        })
      }
    },

    async created() {
      // Build wallet options from user's wallets
      this.walletOptions = this.g.user.wallets.map(w => ({
        label: w.name,
        value: w.id
      }))

      // Load all data
      await this.loadStats()
      await this.loadWallet()
      await this.loadMiners()
      await this.loadRequests()
      await this.loadBulletins()
      await this.loadPromoCodes()
    }
  })

  window.app.mount('#vue')
</script>
{% endblock %}
